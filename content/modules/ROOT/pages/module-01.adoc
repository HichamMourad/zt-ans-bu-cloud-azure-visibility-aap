= Lab Guide: Azure Dynamic Inventory and Visibility
:notoc:
:toc-title: Table of Contents
:sectnums:
:icons: font

_A guide to understanding and using the automation controller to create and manage a dynamic inventory for Microsoft Azure._

---

== Lab Briefing

This section provides an overview of the lab environment and key concepts in Ansible Automation Platform.

=== Lab Instructions

Please click the green **Start** button on the bottom right corner to create the lab environment if it has not already started. To navigate through this briefing, click the white `>` arrow on the right.

image:https://github.com/IPvSean/pictures_for_github/blob/master/start_button.png?raw=true[Start Button, 100, opts="border"]

=== Automation controller

The control plane for Ansible Automation Platform is the **automation controller**. It helps standardize how automation is deployed, initiated, delegated, and audited. You can manage inventory, launch and schedule workflows, track changes, and integrate reporting, all from a centralized user interface and RESTful API.

image:https://github.com/IPvSean/pictures_for_github/blob/master/automation_controller.png?raw=true[Automation controller dashboard, 600, opts="border"]

=== Inventories

An **inventory** is a collection of hosts against which jobs can be launched, similar to an Ansible inventory file. Inventories are divided into groups, and these groups contain the actual hosts. Groups can be sourced manually or dynamically from a supported cloud provider using **Inventory Plugins**.

Some of the available inventory plugins include:

* Amazon Web Services EC2
* Google Compute Engine
* Microsoft Azure Resource Manager
* VMware vCenter

=== Lab Diagram

This diagram shows the topology for this lab.

image::https://github.com/IPvSean/pictures_for_github/blob/master/ansible-for-azure-infrastructure-visibility/diagram.png?raw=true[Lab topology diagram, opts="border"]

This concludes your lab briefing.

---

== Lab Guide: Hands-On Tasks

*Estimated time to complete: 10 minutes*

Welcome to the Ansible for Azure Automation - Infrastructure Visibility lab. In this first challenge, you will learn how to set up a dynamic inventory for Azure virtual machines in the automation controller.

First, log in to the automation controller with the following credentials.

.Login Credentials
[cols="1,2a"]
|===
| Username | `admin`
| Password | `ansible123!`
|===

=== Task 1: Configure Credentials

Credentials are used to authenticate to machines, inventory sources, and version control systems. The `azure_credential` for accessing the Azure cloud is already configured. You will now create a **Machine** credential to access the RHEL virtual machine.

. **Navigate to the Credentials page.**
+
In the left navigation menu, go to **Resources** → **Credentials**.

. **Create a new credential.**
+
**Click** the blue **Add** button.
+
image::../assets/add_button.png[Add button on the Credentials page, opts="border"]

. **Enter the credential details.**
+
Fill out the form with the following information:
+
[cols="1,1"]
|===
| Parameter | Value
| Name | `RHEL on Azure`
| Organization | `Default`
| Credential Type | `Machine`
| Username | `rheluser`
| Password | `RedHatAnsible123!`
|===

. **Save the credential.**
+
**Click** the blue **Save** button at the bottom.

NOTE: Passwords and keys are encrypted. Once saved in the automation controller, no one, including administrators, can view the sensitive values.

=== Task 2: Create an Inventory

Next, you will create a new inventory to hold your dynamically discovered hosts from Azure.

. **Navigate to the Inventories page.**
+
In the left navigation menu, go to **Resources** → **Inventories**.

. **Create a new inventory.**
+
**Click** the blue **Add** button and select **Add inventory**.
+
image:https://github.com/IPvSean/pictures_for_github/blob/master/add_inventory.png?raw=true[Add a new inventory, 200, opts="border"]

. **Enter the inventory details.**
+
[cols="1,1"]
|===
| Parameter | Value
| Name | `Azure Inventory`
| Organization | `Default`
|===

. **Save the inventory.**
+
**Click** the blue **Save** button.

=== Task 3: Create an Inventory Source

Now you will configure a source to dynamically pull host information from your Azure account into the inventory.

. **Navigate to the Sources tab.**
+
Within your newly created `Azure Inventory`, **click** the **Sources** tab.
+
image:https://github.com/IPvSean/pictures_for_github/blob/master/sources-savage.png?raw=true[Inventory Sources tab, 300, opts="border"]

. **Create a new source.**
+
**Click** the blue **Add** button.

. **Enter the source details.**
+
Fill out the form with the following information:
+
[cols="1,1"]
|===
| Parameter | Value
| Name | `Azure Source`
| Execution Environment | `Microsoft Azure Execution Environment`
| Source | `Microsoft Azure Resource Manager`
| Credential | `azure_credential`
|===

. **Add the source variables.**
+
In the `Source variables` YAML editor, **paste** the following code. This configures the inventory to use the `name` tag as the hostname and the public IP address for connections.
+
[source,yaml]
----
---
hostnames:
  - tags.name
compose:
  ansible_host: public_ipv4_address[0]
----

. **Save and sync the source.**
+
**Click** **Save**, then **click** **Sync** to retrieve the inventory from Microsoft Azure.

=== Task 4: Examine the Inventory and Run an Ad-Hoc Command

Finally, you will examine the discovered hosts and run a command to verify connectivity.

. **Navigate to the Hosts view.**
+
Once the sync is complete, return to the `Azure Inventory` details and **click** the **Hosts** tab. You should see two hosts listed: `RHEL-ansible` and `WIN-ansible`.
+
image:https://github.com/IPvSean/pictures_for_github/blob/master/ansible-for-azure-infrastructure-visibility/azure_inventory_menu.png?raw=true[Azure Inventory menu, 400, opts="border"]

. **Run an ad-hoc command on the RHEL host.**
+
**Select the checkbox** next to `RHEL-ansible` and **click** the **Run Command** button. A wizard will appear.

. **Configure the command.**
+
Fill out the wizard prompts as follows:
+
--
a. *Details View:* From the *Module* dropdown, select `ping`. Click **Next**.
b. *Execution Environment View:* Select `Default execution environment`. Click **Next**.
c. *Credential View:* Select `RHEL on Azure`. Click **Next**.
--

. **Launch the ad-hoc command.**
+
On the *Preview* screen, **click** the **Launch** button.

The ad-hoc command runs the Ansible link:https://docs.ansible.com/ansible/latest/collections/ansible/builtin/ping_module.html[ping] module, which verifies connectivity to the RHEL instance running on Azure.

---

== Next Steps

Press the `Check` button below to proceed to the next challenge.

== Troubleshooting

If you have encountered an issue or have noticed something not quite right, please link:https://github.com/ansible/instruqt/issues/new?title=Issue+with+Ansible+Hybrid+Cloud+Automation+-+Infrastructure+visibility&assignees=ipvsean[open an issue on GitHub].
